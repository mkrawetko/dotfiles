#!/usr/bin/env bash
## My own but still generic aliases etc..

# --- rm ---
rmFRec() {
  find . -type f -name "$1" -print0 | xargs -0 -I {} rm -v "{}"
}
#Find all files having .iml (*.iml) extension recursively and remove
alias rmImlRec='rmFRec "*.iml"'
#Find all files having .lastUpdated (*.lastUpdated) extension recursively and remove from ~/m2/repository
alias rmM2LastURec='cd ~/.m2/repository && rmFRec "*.lastUpdated" && cd -'

alias gwDepTreeByBuildKts='find . -type f -name build.gradle.kts | grep -v buildSrc | xargs -I {} ./gradlew -b "{}" dependencies | tee depTree-"$(date '+%Y%m%d%H%M%S')".txt'

### --- GREP ---
GREP_EXCLUDE_DIR_USELESS=(-I --exclude-dir={.bzr,CVS,.git,.hg,.svn,.idea,.tox} --exclude=\*.{class,dbf})
GREP_EXCLUDE_DIR_TEST=(--exclude-dir="*test*")
GREP_INCLUDE_JAVA=(--include=\*.{"java","kt"})
GREP_INCLUDE_SQL=(--include="*.sql")
GREP_INCLUDE_XML=(--include="*.xml")
ALL_RESOURCES='*'
MAIN_RESOURCES='*src/main/*'
TEST_RESOURCES='*src/test/*'
grepAll() {
  PATH_PATTERN=$1
  set -o xtrace
  find . -path "$PATH_PATTERN" -type d -print0 | xargs -0 grep --color=auto -E --recursive "${GREP_EXCLUDE_DIR_USELESS[@]}" "${@:2}"
  set +o xtrace
}
grepSql() {
  grepAll "$ALL_RESOURCES" "${GREP_INCLUDE_SQL[@]}" "$@"
}
grepXml() {
  grepAll "$ALL_RESOURCES" "${GREP_INCLUDE_XML[@]}" "$@"
}
grepProd() {
  grepAll "$MAIN_RESOURCES" "${GREP_EXCLUDE_DIR_TEST[@]}" "$@"
}
grepTest() {
  grepAll "$TEST_RESOURCES" "$@"
}
grepProdJava() {
  grepProd "${GREP_INCLUDE_JAVA[@]}" "$@"
}
grepTestJava() {
  grepTest "${GREP_INCLUDE_JAVA[@]}" "$@"
}

alias grepR='grepAll "*" '


### --Properties
exportConfIntoEnv(){
  ## usage example: exportConfIntoEnv frequentFlyer/conf.yaml
  set -o xtrace
  export $(grep -v '^#' "$HOME"/.config/"$1" | sed 's/: /=/g' | xargs)
  set +o xtrace
}

### --- Login to Google Cloud Registry (GCR) with the key ---
export GCR_SERVICE_ACCOUNT_KEY_PATH="$HOME"/.config/gcloud/GCR_SERVICE_ACCOUNT_KEY.json
lGCR() {
  docker login -u _json_key --password-stdin eu.gcr.io <"$GCR_SERVICE_ACCOUNT_KEY_PATH"
}

### --- JAVA ---
java17Path() {
  case "$OSTYPE" in
  darwin*) /usr/libexec/java_home -v 17 ;;
  linux*) update-alternatives --list java | grep java-17 | head -c -10 ;;
  *) echo "unknown: $OSTYPE" ;;
  esac
}

java8Path() {
  case "$OSTYPE" in
  darwin*) /usr/libexec/java_home -v 1.8.0 ;;
  linux*) update-alternatives --list java | grep java-8 | head -c -10 ;;
  *) echo "unknown: $OSTYPE" ;;
  esac
}
java17Export() {
  JAVAPATH="$(java17Path)"
  export JAVA_HOME=$JAVAPATH
}
java8Export() {
  JAVAPATH="$(java8Path)"
  export JAVA_HOME=$JAVAPATH
}

java17Export


importCertificate(){
  if [ $# -ne 2 ]
    then
      echo "requires 2 arguments: alias /certificate/path"
    else
      ALIAS=$1
      CERTIFICATE_PATH=$2
      set -o xtrace
      sudo "$JAVA_HOME"/bin/keytool -importcert -alias "$ALIAS" -file "$CERTIFICATE_PATH" -keystore "$JAVA_HOME"/lib/security/cacerts -storepass changeit -noprompt
      set +o xtrace
  fi
}


### --- Maven ---
export M2_HOME="${HOME}/workspace/tools/maven"
export PATH="/usr/local/bin:$PATH:${M2_HOME}/bin"
